---
title: "Spatial Econometrics"
author: "Grzegorz Krochmal and Ewelina Osowska"
date: ""
output:
  html_document:
    toc: true
---
<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 120)
```

### Introduction

The following analysis ... 

### Dataset 
<!--opisać na podstawie jakich danych zostały wzięte poszczególne kategorie danych-->
The dataset used in the analysis is created by the authors based on several sources. There are three general groups of variables including property characteristics, spatial characteristics and district characteristics. Property characteristics were obtained from Otodom.pl website with the use of scraper.... 

Below table presents all the variables with its descriptions.

```{r warning=FALSE, message=FALSE}
df_final <- readxl::read_excel("df_final_v3.xlsx")
df_final$...1 <- NULL
```

```{r}
variables <- matrix(c(
  "District", "The district",
  "Total price", "Total price of the property in PLN",
  "Days from initial announcement", "Days from initial announcement",
  "Czynsz", "Rent",
  "Forma własności", "Form of ownership",
  "Piętro", "Floor",
  "Rodzaj zabudowy", "Type of construction",
  "Stan wykończenia", "Finishing condition",
  "Liczba pięter", "Number of floors in the building",
  "Rynek", "Property market",
  "Powierzchnia", "Area of the property in squared metres",
  "Liczba pokoi", "Number of rooms",
  "Rok budowy", "Year built ",
  "Ogrzewanie","Heating type",
  "Lat","Latitude of the property",
  "Lon","Longitude of the property",
  "Distance_to_PKIN_in_km","Distance to the center (indicated by the PKiN building) in km",
  "Time_to_PKIN_in_minutes","Time to the center (indicated by the PKiN building) in minutes", # stopami czy jak?
  "Distance_to_subway_in_km","Distance to the nearest subway in km",
  "Price_per_sqm","Price per square metre",
  "Population_density","Population density", # of what?
  "Vistula_side(1_for_west_0_for_east)","Which side of the Vistula the property is located (1=West, 0=East)",
  "Life_quality","Life quality within a district",
  "Family_friendliness","Family friendliness within a district",
  "Single_people_friendliness","Single people friendliness within a district",
  "Senior_people_friendliness","Senior people friendliness within a district"
  ), 
  ncol=2,byrow=TRUE)
colnames(variables) <- c("Variable Name", "Variable description")
library(knitr)
kable(variables)
```


### Data preparation

This section serves a purpose ...

**Variables formatting and feature engineering**

```{r}
nums <- sapply(df_final, is.numeric)
df_final_nums <- df_final[,nums]
head(df_final_nums)
```
```{r}
oth <- which(!nums)
df_final_oth <- df_final[,oth]
head(df_final_oth)
```

```{r}
df_final$`Vistula_side(1_for_west_0_for_east)` <- as.factor(df_final$`Vistula_side(1_for_west_0_for_east)`)
df_final$District <- as.factor(df_final$District)
df_final$`Forma własności` <- as.factor(df_final$`Forma własności`)
df_final$`Rodzaj zabudowy` <- as.factor(df_final$`Rodzaj zabudowy`)
df_final$`Stan wykończenia` <- as.factor(df_final$`Stan wykończenia`)
df_final$Rynek <- as.factor(df_final$Rynek)
df_final$Ogrzewanie <- as.factor(df_final$Ogrzewanie)
```

```{r}
library(ggplot2)
ggplot(df_final, aes(x = `Liczba pięter`, y = Price_per_sqm)) + 
  geom_point() +
  theme_minimal()
```

```{r}
df_final$liczba_pieter_binned <- 
  ifelse(df_final$`Liczba pięter` < 2, "<= 2", 
       ifelse(df_final$`Liczba pięter` > 2 & df_final$`Liczba pięter` <= 4, "> 2 & <= 4",
              ifelse(df_final$`Liczba pięter` > 4 & df_final$`Liczba pięter` <= 28, "> 4 & <= 28", 
                     ifelse(df_final$`Liczba pięter` > 28, "> 28", 0))))

df_final$liczba_pieter_binned <- as.factor(df_final$liczba_pieter_binned)
```

```{r}
# difference in years from the year built
# Rok budowy - zmienna jako wiek budynku
df_final$`Rok budowy` <- ifelse(df_final$`Rok budowy`==19885, 1985, df_final$`Rok budowy`)
df_final$`Rok budowy` <- ifelse(df_final$`Rok budowy`==20112, 2012, df_final$`Rok budowy`)
df_final$`Rok budowy` <- ifelse(df_final$`Rok budowy`==20110, 2010, df_final$`Rok budowy`)

df_final$building_age <- 2020 - df_final$`Rok budowy`
```

```{r}
ggplot(df_final, aes(x = building_age, y = Price_per_sqm)) + 
  geom_point() +
  theme_minimal()
```

```{r}
df_final$building_age_binned <- 
  ifelse(df_final$building_age <= 0, "<= 0", 
       ifelse(df_final$building_age > 0 & df_final$building_age <= 12, "> 0 & <= 12",
              ifelse(df_final$building_age > 12 & df_final$building_age <= 64, "> 12 & <= 64", 
                     ifelse(df_final$building_age > 64 & df_final$building_age <= 105, "> 64 & <= 105",
                            ifelse(df_final$building_age > 105, "> 105", 0)))))

df_final$building_age_binned <- as.factor(df_final$building_age_binned)
```

```{r}
df_final$Days_from_initial_announcement <- ifelse(df_final$Days_from_initial_announcement=="Less than a day", 0, df_final$Days_from_initial_announcement)
df_final$Days_from_initial_announcement <- as.integer(df_final$Days_from_initial_announcement)
```

```{r}
ggplot(df_final, aes(x = Days_from_initial_announcement, y = Price_per_sqm)) + 
  geom_point() +
  theme_minimal()
```

```{r}
df_final$Days_from_initial_announcement_binned <- 
  ifelse(df_final$Days_from_initial_announcement == 0, "Less than a day", 
       ifelse(df_final$Days_from_initial_announcement > 0 & df_final$building_age <= 7, "Week or less than a week",
              ifelse(df_final$building_age > 7 & df_final$building_age <= 30, "Month or less than a month", 
                     ifelse(df_final$building_age > 30 & df_final$building_age <= 365, "Year or ess than a year",
                            ifelse(df_final$building_age > 365, "Over a year", 0)))))

df_final$Days_from_initial_announcement_binned <- as.factor(df_final$Days_from_initial_announcement_binned)
```

```{r}
df_final$Piętro <- as.factor(df_final$Piętro)
levels(df_final$Piętro)

df_final$Piętro_binned <- df_final$Piętro
levels(df_final$Piętro_binned) <- c("> 10","=> 1 & <= 5","> 5 & <= 10","=> 1 & <= 5","=> 1 & <= 5","=> 1 & <= 5","=> 1 & <= 5","> 5 & <= 10","> 5 & <= 10","> 5 & <= 10","> 5 & <= 10","parter","poddasze","suterena")
levels(df_final$Piętro_binned)
```

```{r}
df_final$`Liczba pokoi` <- as.factor(df_final$`Liczba pokoi`)
levels(df_final$`Liczba pokoi`)

df_final$liczba_pokoi_binned <- df_final$`Liczba pokoi`
levels(df_final$liczba_pokoi_binned) <- c("1 - 2","3 - 5","3 - 5","3 - 5","3 - 5","6 - 10","6 - 10","6 - 10","6 - 10","> 10")
levels(df_final$liczba_pokoi_binned)
```



**Missing values treatment**

```{r}
colMeans(is.na(df_final))
sum(!is.na(df_final$Czynsz))
```

*Rent*

https://www.researchgate.net/publication/5142421_Determinants_of_Market_Rent

```{r}
fit_rent <- lm(Czynsz ~ District + Total_price + Powierzchnia + Price_per_sqm + Distance_to_PKIN_in_km + Distance_to_subway_in_km, data = df_final)
library(dplyr)
df3 <- df_final %>% 
  dplyr::mutate(pred = predict(fit_rent, .)) %>%
  dplyr::mutate(czynsz_new = ifelse(is.na(Czynsz), pred, Czynsz))

# See the result
df3 %>% as.data.frame()
```



### Initial analysis
<!-- mapka ze średnimi cenami vs dzielnica, średni czynsz vs dzielnica - z pythona, Grzesiek chciał zrobić -->



### Empirical analysis

In order to estimate housing prices, we run several models and then compare them with respect to prediction power. There are three types of models which we consider: regular OLS regression, spatial algorithms and non-parametric algorithms. 

#### OLS regression


#### Spatial models
<!--macierz wag, test I Morana, jakość modeli: AIC, BIC, LogLik-->

#### Non-parametric models



